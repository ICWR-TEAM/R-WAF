<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R-WAF Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Courier New', monospace;
            background-color: black;
            color: white;
            line-height: 1.6;
        }
        
        .dashboard {
            display: flex;
            height: 100vh;
        }
        
        .sidebar {
            width: 250px;
            background: #0a0a0a;
            border-right: 1px solid #333;
            display: flex;
            flex-direction: column;
            transition: all 0.3s;
            position: relative;
        }
        
        .sidebar.collapsed {
            width: 60px;
        }
        
        .sidebar.collapsed .sidebar-header h1,
        .sidebar.collapsed .sidebar-header p,
        .sidebar.collapsed .nav-item div,
        .sidebar.collapsed .logout-btn {
            opacity: 0;
            visibility: hidden;
        }
        
        .sidebar.collapsed .sidebar-header img {
            margin: 0 auto;
        }
        
        @media (max-width: 768px) {
            .sidebar.collapsed {
                width: 250px;
            }
            
            .sidebar.collapsed .sidebar-header h1,
            .sidebar.collapsed .sidebar-header p,
            .sidebar.collapsed .nav-item div,
            .sidebar.collapsed .logout-btn {
                opacity: 1;
                visibility: visible;
            }
        }
        
        .sidebar-toggle {
            position: absolute;
            top: 50%;
            right: -15px;
            width: 30px;
            height: 30px;
            background: white;
            color: black;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            z-index: 10;
            transition: all 0.3s;
            transform: translateY(-50%);
        }
        
        .sidebar-toggle:hover {
            background: #ddd;
        }
        
        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .sidebar-header img {
            width: 40px;
            height: 40px;
        }
        
        .sidebar-header h1 {
            font-size: 1.2em;
        }
        
        .sidebar-nav {
            flex: 1;
            padding: 20px 0;
        }
        
        .nav-item {
            padding: 15px 20px;
            cursor: pointer;
            border-left: 3px solid transparent;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .nav-item i {
            font-size: 1.2em;
            opacity: 0.7;
            transition: all 0.3s;
        }
        
        .nav-item:hover i {
            opacity: 1;
        }
        
        .nav-item.active i {
            opacity: 1;
        }
        
        .nav-item:hover {
            background: #1a1a1a;
            border-left-color: white;
        }
        
        .nav-item.active {
            background: #1a1a1a;
            border-left-color: white;
        }
        
        .sidebar-footer {
            padding: 20px;
            border-top: 1px solid #333;
        }
        
        .logout-btn {
            width: 100%;
            background: transparent;
            border: 1px solid white;
            color: white;
            padding: 10px;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.3s;
        }
        
        .logout-btn:hover {
            background: white;
            color: black;
        }
        
        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
            transition: margin-left 0.3s;
        }
        
        @media (min-width: 769px) {
            .mobile-toggle {
                display: none !important;
            }
        }
        
        .page {
            display: none;
        }
        
        .page.active {
            display: block;
        }
        
        .page-header {
            margin-bottom: 30px;
        }
        
        .page-header h2 {
            font-size: 2em;
            margin-bottom: 5px;
        }
        
        .page-header p {
            opacity: 0.7;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: #1a1a1a;
            border: 1px solid #333;
            padding: 20px;
            border-radius: 5px;
        }
        
        .stat-card h3 {
            font-size: 0.9em;
            margin-bottom: 10px;
            opacity: 0.8;
        }
        
        .stat-card .value {
            font-size: 2em;
            font-weight: bold;
        }
        
        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .chart-card {
            background: #1a1a1a;
            border: 1px solid #333;
            padding: 20px;
            border-radius: 5px;
        }
        
        .chart-card h3 {
            margin-bottom: 15px;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
        }
        
        .timeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            gap: 15px;
        }
        
        .timeline-filters {
            display: flex;
            gap: 10px;
            align-items: flex-end;
            flex-wrap: wrap;
        }
        
        @media (max-width: 768px) {
            .timeline-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .timeline-filters {
                width: 100%;
                flex-direction: column;
                align-items: stretch;
            }
            
            .timeline-filters .filter-group {
                width: 100%;
            }
            
            .timeline-filters button {
                width: 100%;
            }
        }
        
        .chart-container.small {
            height: 200px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: #1a1a1a;
            border: 1px solid #333;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #333;
        }
        
        th {
            background: #0a0a0a;
            font-weight: bold;
        }
        
        .filters {
            background: #1a1a1a;
            border: 1px solid #333;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        
        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
            position: relative;
        }
        
        .filter-group.datetime-input::after {
            content: '\F1EC';
            font-family: 'bootstrap-icons';
            position: absolute;
            right: 12px;
            bottom: 0;
            height: 38px;
            display: flex;
            align-items: center;
            pointer-events: none;
            color: white;
            opacity: 0.7;
            font-size: 1.2em;
        }
        
        input[type="datetime-local"] {
            padding-right: 40px;
        }
        
        label {
            font-size: 0.9em;
            opacity: 0.8;
        }
        
        input, select, button {
            background: black;
            border: 1px solid white;
            color: white;
            padding: 8px 12px;
            font-family: inherit;
            border-radius: 3px;
        }
        
        button {
            cursor: pointer;
            transition: all 0.3s;
        }
        
        button:hover {
            background: white;
            color: black;
        }
        
        .btn-primary {
            background: white;
            color: black;
        }
        
        .btn-primary:hover {
            background: black;
            color: white;
        }
        
        .btn-danger {
            background: aqua;
            border-color: aqua;
            color: black;
        }
        
        .btn-danger:hover {
            background: #00aaaa;
            color: black;
        }
        
        .pagination {
            display: flex;
            gap: 5px;
            justify-content: center;
            margin-top: 20px;
        }
        
        .pagination button {
            min-width: 40px;
        }
        
        .pagination button.active {
            background: white;
            color: black;
        }
        
        .status-badge {
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 0.85em;
        }
        
        .status-active {
            background: aqua;
            color: black;
        }
        
        .status-expired {
            background: #444;
        }
        
        .status-allowed {
            background: aqua;
            color: black;
        }
        
        .status-blocked {
            background: white;
            color: black;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: black;
            border: 2px solid white;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            border-radius: 5px;
        }
        
        .modal-header {
            margin-bottom: 20px;
            font-size: 1.5em;
        }
        
        .modal-body {
            margin-bottom: 20px;
        }
        
        .modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        .mobile-toggle {
            display: none;
            position: fixed;
            top: 20px;
            left: 20px;
            background: white;
            color: black;
            border: none;
            padding: 10px 15px;
            cursor: pointer;
            z-index: 100;
            border-radius: 3px;
        }
        
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 998;
        }
        
        .sidebar-overlay.active {
            display: block;
        }
        
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: 0;
                top: 0;
                height: 100vh;
                z-index: 999;
                transform: translateX(-100%);
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .sidebar.collapsed {
                width: 250px;
            }
            
            .sidebar-toggle {
                display: none;
            }
            
            .mobile-toggle {
                display: block;
            }
            
            .main-content {
                padding: 80px 15px 15px 15px;
                width: 100%;
            }
            
            .stats-grid, .chart-grid, .filter-row {
                grid-template-columns: 1fr;
            }
            
            .chart-card > div[style*="position: relative"] {
                max-width: 200px !important;
                height: 200px !important;
            }
            
            .chart-card > div[style*="display: flex"] {
                flex-direction: column !important;
            }
        }
    </style>
</head>
<body>
    <button class="mobile-toggle" onclick="toggleSidebar()">☰ Menu</button>
    <div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>
    
    <div class="dashboard">
        <div class="sidebar" id="sidebar">
            <button class="sidebar-toggle" onclick="toggleSidebarCollapse()">◀</button>
            
            <div class="sidebar-header">
                <img src="/static/icwr-logo.png" alt="Logo">
                <div>
                    <h1>R-WAF</h1>
                    <p style="font-size: 0.8em; opacity: 0.7;">Dashboard</p>
                </div>
            </div>
            
            <div class="sidebar-nav">
                <div class="nav-item active" onclick="navigateTo('overview')">
                    <i class="bi bi-speedometer2"></i>
                    <div>Overview</div>
                </div>
                <div class="nav-item" onclick="navigateTo('alerts')">
                    <i class="bi bi-exclamation-triangle"></i>
                    <div>Alerts</div>
                </div>
                <div class="nav-item" onclick="navigateTo('traffic')">
                    <i class="bi bi-globe"></i>
                    <div>Traffic</div>
                </div>
                <div class="nav-item" onclick="navigateTo('bans')">
                    <i class="bi bi-shield-x"></i>
                    <div>Bans</div>
                </div>
            </div>
            
            <div class="sidebar-footer">
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
        </div>
        
        <div class="main-content">
            <div class="page active" id="overview-page">
                <div class="page-header">
                    <h2>System Overview</h2>
                    <p>Real-time monitoring and statistics</p>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Total Alerts</h3>
                        <div class="value" id="total-alerts">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Blocked IPs</h3>
                        <div class="value" id="blocked-ips">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Active Bans</h3>
                        <div class="value" id="active-bans">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Total Requests</h3>
                        <div class="value" id="total-requests">0</div>
                    </div>
                </div>
                
                <div class="chart-grid">
                    <div class="chart-card">
                        <h3>CPU Usage</h3>
                        <div style="position: relative; height: 250px; margin: 20px auto; max-width: 250px;">
                            <canvas id="cpuChart"></canvas>
                            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; pointer-events: none;">
                                <div style="font-size: clamp(1.8em, 5vw, 2.5em); font-weight: bold; color: aqua; line-height: 1;" id="cpu-value">0%</div>
                                <div style="font-size: clamp(0.7em, 2vw, 0.9em); opacity: 0.7; margin-top: 5px;">CPU</div>
                            </div>
                        </div>
                    </div>
                    <div class="chart-card">
                        <h3>Memory Usage</h3>
                        <div style="position: relative; height: 250px; margin: 20px auto; max-width: 250px;">
                            <canvas id="memoryChart"></canvas>
                            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; pointer-events: none;">
                                <div style="font-size: clamp(1.8em, 5vw, 2.5em); font-weight: bold; color: aqua; line-height: 1;" id="memory-value">0%</div>
                                <div style="font-size: clamp(0.6em, 1.5vw, 0.8em); opacity: 0.7; margin-top: 5px;" id="memory-details">0 MB / 0 MB</div>
                            </div>
                        </div>
                    </div>
                    <div class="chart-card">
                        <h3>Disk Usage</h3>
                        <div style="position: relative; height: 250px; margin: 20px auto; max-width: 250px;">
                            <canvas id="diskChart"></canvas>
                            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; pointer-events: none;">
                                <div style="font-size: clamp(1.8em, 5vw, 2.5em); font-weight: bold; color: aqua; line-height: 1;" id="disk-value">0%</div>
                                <div style="font-size: clamp(0.6em, 1.5vw, 0.8em); opacity: 0.7; margin-top: 5px;" id="disk-details">0 GB / 0 GB</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="chart-grid">
                    <div class="chart-card">
                        <h3>Traffic Summary (Last 24h)</h3>
                        <div style="display: flex; gap: 20px; margin-top: 20px;">
                            <div style="flex: 1; padding: 20px; border: 1px solid aqua; border-radius: 5px;">
                                <div style="font-size: 2.5em; font-weight: bold; color: aqua; line-height: 1;" id="traffic-allowed">0</div>
                                <div style="opacity: 0.7; margin-top: 10px;">Allowed Requests</div>
                            </div>
                            <div style="flex: 1; padding: 20px; border: 1px solid white; border-radius: 5px;">
                                <div style="font-size: 2.5em; font-weight: bold; color: white; line-height: 1;" id="traffic-blocked">0</div>
                                <div style="opacity: 0.7; margin-top: 10px;">Blocked Requests</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="chart-card">
                    <div class="timeline-header">
                        <h3 style="margin: 0;">Traffic & System Timeline</h3>
                        <div class="timeline-filters">
                            <div class="filter-group datetime-input" style="margin-bottom: 0;">
                                <label style="font-size: 0.85em;">Start DateTime</label>
                                <input type="datetime-local" id="timeline-start-datetime" style="padding: 8px; font-size: 0.9em;">
                            </div>
                            <div class="filter-group datetime-input" style="margin-bottom: 0;">
                                <label style="font-size: 0.85em;">End DateTime</label>
                                <input type="datetime-local" id="timeline-end-datetime" style="padding: 8px; font-size: 0.9em;">
                            </div>
                            <button class="btn-primary" onclick="loadTimelineData()" style="padding: 8px 16px; height: fit-content;">Apply</button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="timelineChart"></canvas>
                    </div>
                </div>
                
                <div style="margin-top: 40px;"></div>
                
                <div class="chart-grid">
                    <div class="chart-card">
                        <h3>Network Speed</h3>
                        <div style="display: flex; gap: 20px; margin-top: 20px;">
                            <div style="flex: 1; padding: 20px; border: 1px solid aqua; border-radius: 5px;">
                                <div style="font-size: 2em; font-weight: bold; color: aqua; line-height: 1;" id="upload-speed">0</div>
                                <div style="opacity: 0.7; margin-top: 10px;">Upload (MB/s)</div>
                            </div>
                            <div style="flex: 1; padding: 20px; border: 1px solid white; border-radius: 5px;">
                                <div style="font-size: 2em; font-weight: bold; color: white; line-height: 1;" id="download-speed">0</div>
                                <div style="opacity: 0.7; margin-top: 10px;">Download (MB/s)</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="chart-card">
                    <h3>Network Speed Timeline</h3>
                    <div class="chart-container">
                        <canvas id="networkChart"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="page" id="alerts-page">
                <div class="page-header">
                    <h2>Security Alerts</h2>
                    <p>Monitor and analyze security events</p>
                </div>
                
                <div class="filters">
                    <div class="filter-row">
                        <div class="filter-group datetime-input">
                            <label>Start DateTime</label>
                            <input type="datetime-local" id="alerts-start-datetime">
                        </div>
                        <div class="filter-group datetime-input">
                            <label>End DateTime</label>
                            <input type="datetime-local" id="alerts-end-datetime">
                        </div>
                        <div class="filter-group">
                            <label>Keyword</label>
                            <input type="text" id="alerts-keyword" placeholder="Search...">
                        </div>
                        <div class="filter-group" style="justify-content: flex-end;">
                            <label>&nbsp;</label>
                            <button class="btn-primary" onclick="filterAlerts()">Search</button>
                        </div>
                    </div>
                </div>
                
                <table>
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>IP</th>
                            <th>Module</th>
                            <th>Action</th>
                            <th>Reason</th>
                            <th>Path</th>
                        </tr>
                    </thead>
                    <tbody id="alerts-table">
                        <tr>
                            <td colspan="6" style="text-align: center;">Loading...</td>
                        </tr>
                    </tbody>
                </table>
                
                <div class="pagination" id="alerts-pagination"></div>
            </div>
            
            <div class="page" id="traffic-page">
                <div class="page-header">
                    <h2>Traffic Logs</h2>
                    <p>Monitor all HTTP requests</p>
                </div>
                
                <div class="filters">
                    <div class="filter-row">
                        <div class="filter-group datetime-input">
                            <label>Start DateTime</label>
                            <input type="datetime-local" id="traffic-start-datetime">
                        </div>
                        <div class="filter-group datetime-input">
                            <label>End DateTime</label>
                            <input type="datetime-local" id="traffic-end-datetime">
                        </div>
                        <div class="filter-group">
                            <label>Action</label>
                            <select id="traffic-action">
                                <option value="">All</option>
                                <option value="allow">Allowed</option>
                                <option value="block">Blocked</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Keyword</label>
                            <input type="text" id="traffic-keyword" placeholder="Search...">
                        </div>
                        <div class="filter-group" style="justify-content: flex-end;">
                            <label>&nbsp;</label>
                            <button class="btn-primary" onclick="filterTraffic()">Search</button>
                        </div>
                    </div>
                </div>
                
                <table>
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>IP</th>
                            <th>Method</th>
                            <th>Path</th>
                            <th>Action</th>
                            <th>Reason</th>
                        </tr>
                    </thead>
                    <tbody id="traffic-table">
                        <tr>
                            <td colspan="6" style="text-align: center;">Loading...</td>
                        </tr>
                    </tbody>
                </table>
                
                <div class="pagination" id="traffic-pagination"></div>
            </div>
            
            <div class="page" id="bans-page">
                <div class="page-header">
                    <h2>Ban Management</h2>
                    <p>Manage IP bans and whitelist</p>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <button class="btn-primary" onclick="showBanModal()">+ Add Manual Ban</button>
                </div>
                
                <table>
                    <thead>
                        <tr>
                            <th>IP Address</th>
                            <th>Reason</th>
                            <th>Banned Until</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="bans-table">
                        <tr>
                            <td colspan="5" style="text-align: center;">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div class="modal" id="ban-modal">
        <div class="modal-content">
            <div class="modal-header">Add Manual Ban</div>
            <div class="modal-body">
                <div class="filter-group" style="margin-bottom: 15px;">
                    <label>IP Address</label>
                    <input type="text" id="ban-ip" placeholder="192.168.1.100">
                </div>
                <div class="filter-group" style="margin-bottom: 15px;">
                    <label>Reason</label>
                    <input type="text" id="ban-reason" placeholder="Malicious activity">
                </div>
                <div class="filter-group">
                    <label>Duration (minutes)</label>
                    <input type="number" id="ban-duration" value="15">
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="closeBanModal()">Cancel</button>
                <button class="btn-danger" onclick="submitBan()">Ban IP</button>
            </div>
        </div>
    </div>
    
    <script>
        const API_KEY = localStorage.getItem('rwaf_api_key');
        let charts = {};
        let currentPage = 'overview';
        
        document.addEventListener('DOMContentLoaded', function() {
            if (!API_KEY) {
                window.location.href = '/dashboard/login';
                return;
            }
            
            const end = new Date();
            const start = new Date();
            start.setDate(start.getDate() - 7);
            
            const formatDateTime = (date) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                return `${year}-${month}-${day}T${hours}:${minutes}`;
            };
            
            start.setHours(0, 0, 0, 0);
            end.setHours(23, 59, 59, 999);
            
            const timelineStart = new Date();
            timelineStart.setHours(timelineStart.getHours() - 24);
            const timelineEnd = new Date();
            
            document.getElementById('alerts-start-datetime').value = formatDateTime(start);
            document.getElementById('alerts-end-datetime').value = formatDateTime(end);
            document.getElementById('traffic-start-datetime').value = formatDateTime(start);
            document.getElementById('traffic-end-datetime').value = formatDateTime(end);
            document.getElementById('timeline-start-datetime').value = formatDateTime(timelineStart);
            document.getElementById('timeline-end-datetime').value = formatDateTime(timelineEnd);
            
            initCharts();
            loadOverviewData();
            
            setInterval(() => {
                if (currentPage === 'overview') {
                    loadOverviewData();
                } else if (currentPage === 'alerts') {
                    loadAlerts();
                } else if (currentPage === 'traffic') {
                    loadTraffic();
                } else if (currentPage === 'bans') {
                    loadBans();
                }
            }, 30000);
        });
        
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
        }
        
        function toggleSidebarCollapse() {
            const sidebar = document.getElementById('sidebar');
            const toggle = event.target;
            sidebar.classList.toggle('collapsed');
            toggle.textContent = sidebar.classList.contains('collapsed') ? '▶' : '◀';
        }
        
        function navigateTo(page) {
            currentPage = page;
            
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('.nav-item').classList.add('active');
            
            document.querySelectorAll('.page').forEach(p => {
                p.classList.remove('active');
            });
            document.getElementById(page + '-page').classList.add('active');
            
            if (window.innerWidth <= 768) {
                toggleSidebar();
            }
            
            if (page === 'alerts') {
                loadAlerts();
            } else if (page === 'traffic') {
                loadTraffic();
            } else if (page === 'bans') {
                loadBans();
            }
        }
        
        function initCharts() {
            charts.cpu = new Chart(document.getElementById('cpuChart').getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: ['Used', 'Free'],
                    datasets: [{
                        data: [0, 100],
                        backgroundColor: ['aqua', '#333'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '75%',
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
            
            charts.memory = new Chart(document.getElementById('memoryChart').getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: ['Used', 'Free'],
                    datasets: [{
                        data: [0, 100],
                        backgroundColor: ['aqua', '#333'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '75%',
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
            
            charts.disk = new Chart(document.getElementById('diskChart').getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: ['Used', 'Free'],
                    datasets: [{
                        data: [0, 100],
                        backgroundColor: ['aqua', '#333'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '75%',
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
            
            charts.timeline = new Chart(document.getElementById('timelineChart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Traffic (Allowed)',
                            data: [],
                            borderColor: '#00ff00',
                            backgroundColor: 'rgba(0, 255, 0, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Traffic (Blocked)',
                            data: [],
                            borderColor: '#ff0000',
                            backgroundColor: 'rgba(255, 0, 0, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            yAxisID: 'y'
                        },
                        {
                            label: 'CPU %',
                            data: [],
                            borderColor: 'whitef00',
                            borderWidth: 2,
                            tension: 0.4,
                            yAxisID: 'y1'
                        },
                        {
                            label: 'Memory %',
                            data: [],
                            borderColor: 'aqua',
                            borderWidth: 2,
                            tension: 0.4,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: 'white'
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: 'white'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        y: {
                            type: 'linear',
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Requests',
                                color: 'white'
                            },
                            ticks: {
                                color: 'white',
                                beginAtZero: true
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Percentage',
                                color: 'white'
                            },
                            ticks: {
                                color: 'white',
                                beginAtZero: true,
                                max: 100
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    }
                }
            });
            
            charts.network = new Chart(document.getElementById('networkChart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Upload (MB/s)',
                            data: [],
                            borderColor: 'aqua',
                            backgroundColor: 'rgba(0, 255, 255, 0.1)',
                            borderWidth: 2,
                            tension: 0.4
                        },
                        {
                            label: 'Download (MB/s)',
                            data: [],
                            borderColor: 'white',
                            backgroundColor: 'rgba(255, 255, 255, 0.1)',
                            borderWidth: 2,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: 'white'
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: 'white'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Speed (MB/s)',
                                color: 'white'
                            },
                            ticks: {
                                color: 'white',
                                beginAtZero: true
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });
        }
        
        async function loadOverviewData() {
            try {
                const [statsRes, trafficStatsRes, systemRes] = await Promise.all([
                    fetch('/dashboard/api/stats', { headers: { 'X-API-Key': API_KEY } }),
                    fetch('/dashboard/api/traffic/stats', { headers: { 'X-API-Key': API_KEY } }),
                    fetch('/dashboard/api/system/current', { headers: { 'X-API-Key': API_KEY } })
                ]);
                
                const stats = await statsRes.json();
                const trafficStats = await trafficStatsRes.json();
                const system = await systemRes.json();
                
                document.getElementById('total-alerts').textContent = stats.total_alerts || 0;
                document.getElementById('blocked-ips').textContent = stats.blocked_ips || 0;
                document.getElementById('active-bans').textContent = stats.active_bans || 0;
                document.getElementById('total-requests').textContent = trafficStats.total_requests || 0;
                
                document.getElementById('cpu-value').textContent = system.cpu_percent + '%';
                charts.cpu.data.datasets[0].data = [system.cpu_percent, 100 - system.cpu_percent];
                charts.cpu.update();
                
                document.getElementById('memory-value').textContent = system.memory_percent + '%';
                document.getElementById('memory-details').textContent = `${system.memory_used_mb} MB / ${system.memory_total_mb} MB`;
                charts.memory.data.datasets[0].data = [system.memory_percent, 100 - system.memory_percent];
                charts.memory.update();
                
                document.getElementById('disk-value').textContent = system.disk_percent + '%';
                document.getElementById('disk-details').textContent = `${system.disk_used_gb} GB / ${system.disk_total_gb} GB`;
                charts.disk.data.datasets[0].data = [system.disk_percent, 100 - system.disk_percent];
                charts.disk.update();
                
                document.getElementById('upload-speed').textContent = system.upload_speed_mbps || 0;
                document.getElementById('download-speed').textContent = system.download_speed_mbps || 0;
                
                loadTimelineData();
                
            } catch (error) {
                console.error('Error loading overview data:', error);
            }
        }
        
        async function loadTimelineData() {
            try {
                const startDateTime = document.getElementById('timeline-start-datetime').value;
                const endDateTime = document.getElementById('timeline-end-datetime').value;
                
                const params = new URLSearchParams();
                if (startDateTime) params.append('start_date', startDateTime);
                if (endDateTime) params.append('end_date', endDateTime);
                params.append('granularity', 'hour');
                
                const [systemHistoryRes, trafficTimelineRes, trafficStatsRes] = await Promise.all([
                    fetch('/dashboard/api/system/history?' + params, { headers: { 'X-API-Key': API_KEY } }),
                    fetch('/dashboard/api/traffic/timeline?' + params, { headers: { 'X-API-Key': API_KEY } }),
                    fetch('/dashboard/api/traffic/stats?' + params, { headers: { 'X-API-Key': API_KEY } })
                ]);
                
                const systemHistory = await systemHistoryRes.json();
                const trafficTimeline = await trafficTimelineRes.json();
                const trafficStats = await trafficStatsRes.json();
                
                const allowedSum = (trafficTimeline.allowed || []).reduce((a, b) => a + b, 0);
                const blockedSum = (trafficTimeline.blocked || []).reduce((a, b) => a + b, 0);
                document.getElementById('traffic-allowed').textContent = allowedSum;
                document.getElementById('traffic-blocked').textContent = blockedSum;
                
                const labels = systemHistory.labels.map(ts => {
                    const d = new Date(ts);
                    return d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                });
                
                charts.timeline.data.labels = labels;
                charts.timeline.data.datasets[0].data = trafficTimeline.allowed || [];
                charts.timeline.data.datasets[1].data = trafficTimeline.blocked || [];
                charts.timeline.data.datasets[2].data = systemHistory.cpu || [];
                charts.timeline.data.datasets[3].data = systemHistory.memory || [];
                charts.timeline.update();
                
                charts.network.data.labels = labels;
                charts.network.data.datasets[0].data = systemHistory.upload || [];
                charts.network.data.datasets[1].data = systemHistory.download || [];
                charts.network.update();
                
            } catch (error) {
                console.error('Error loading timeline data:', error);
            }
        }
        
        async function loadAlerts(page = 1) {
            const startDateTime = document.getElementById('alerts-start-datetime').value;
            const endDateTime = document.getElementById('alerts-end-datetime').value;
            const keyword = document.getElementById('alerts-keyword').value;
            
            const params = new URLSearchParams({ page, per_page: 20 });
            if (startDateTime) params.append('start_date', startDateTime);
            if (endDateTime) params.append('end_date', endDateTime);
            if (keyword) params.append('keyword', keyword);
            
            try {
                const response = await fetch('/dashboard/api/alerts?' + params, {
                    headers: { 'X-API-Key': API_KEY }
                });
                
                const data = await response.json();
                renderAlerts(data.alerts);
                renderPagination(data.page, data.total_pages, 'alerts', loadAlerts);
            } catch (error) {
                console.error('Error loading alerts:', error);
            }
        }
        
        function renderAlerts(alerts) {
            const tbody = document.getElementById('alerts-table');
            
            if (alerts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No alerts found</td></tr>';
                return;
            }
            
            tbody.innerHTML = alerts.map(alert => `
                <tr>
                    <td>${new Date(alert.timestamp).toLocaleString()}</td>
                    <td>${alert.ip}</td>
                    <td>${alert.module}</td>
                    <td>${alert.action}</td>
                    <td>${alert.reason}</td>
                    <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis;">${alert.path}</td>
                </tr>
            `).join('');
        }
        
        async function loadTraffic(page = 1) {
            const startDateTime = document.getElementById('traffic-start-datetime').value;
            const endDateTime = document.getElementById('traffic-end-datetime').value;
            const keyword = document.getElementById('traffic-keyword').value;
            const action = document.getElementById('traffic-action').value;
            
            const params = new URLSearchParams({ page, per_page: 20 });
            if (startDateTime) params.append('start_date', startDateTime);
            if (endDateTime) params.append('end_date', endDateTime);
            if (keyword) params.append('keyword', keyword);
            if (action) params.append('action', action);
            
            try {
                const response = await fetch('/dashboard/api/traffic?' + params, {
                    headers: { 'X-API-Key': API_KEY }
                });
                
                const data = await response.json();
                renderTraffic(data.logs);
                renderPagination(data.page, data.total_pages, 'traffic', loadTraffic);
            } catch (error) {
                console.error('Error loading traffic:', error);
            }
        }
        
        function renderTraffic(logs) {
            const tbody = document.getElementById('traffic-table');
            
            if (logs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No traffic found</td></tr>';
                return;
            }
            
            tbody.innerHTML = logs.map(log => `
                <tr>
                    <td>${new Date(log.timestamp).toLocaleString()}</td>
                    <td>${log.ip}</td>
                    <td>${log.method}</td>
                    <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis;">${log.path || '-'}</td>
                    <td>
                        <span class="status-badge ${log.action === 'block' ? 'status-blocked' : 'status-allowed'}">
                            ${log.action.toUpperCase()}
                        </span>
                    </td>
                    <td>${log.reason || '-'}</td>
                </tr>
            `).join('');
        }
        
        async function loadBans() {
            try {
                const response = await fetch('/dashboard/api/bans', {
                    headers: { 'X-API-Key': API_KEY }
                });
                
                const data = await response.json();
                renderBans(data.bans);
            } catch (error) {
                console.error('Error loading bans:', error);
            }
        }
        
        function renderBans(bans) {
            const tbody = document.getElementById('bans-table');
            
            if (bans.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No banned IPs</td></tr>';
                return;
            }
            
            tbody.innerHTML = bans.map(ban => `
                <tr>
                    <td>${ban.ip}</td>
                    <td>${ban.reason}</td>
                    <td>${new Date(ban.until).toLocaleString()}</td>
                    <td>
                        <span class="status-badge ${ban.active ? 'status-active' : 'status-expired'}">
                            ${ban.active ? 'ACTIVE' : 'EXPIRED'}
                        </span>
                    </td>
                    <td>
                        ${ban.active ? `<button class="btn-danger" onclick="unbanIP('${ban.ip}')">Unban</button>` : '-'}
                    </td>
                </tr>
            `).join('');
        }
        
        function renderPagination(current, total, type, loadFunc) {
            const container = document.getElementById(type + '-pagination');
            
            if (total <= 1) {
                container.innerHTML = '';
                return;
            }
            
            let html = '';
            
            if (current > 1) {
                html += `<button onclick="${loadFunc.name}(${current - 1})">← Prev</button>`;
            }
            
            for (let i = 1; i <= total; i++) {
                if (i === 1 || i === total || (i >= current - 2 && i <= current + 2)) {
                    html += `<button class="${i === current ? 'active' : ''}" onclick="${loadFunc.name}(${i})">${i}</button>`;
                } else if (i === current - 3 || i === current + 3) {
                    html += '<span>...</span>';
                }
            }
            
            if (current < total) {
                html += `<button onclick="${loadFunc.name}(${current + 1})">Next →</button>`;
            }
            
            container.innerHTML = html;
        }
        
        function filterAlerts() {
            loadAlerts(1);
        }
        
        function filterTraffic() {
            loadTraffic(1);
        }
        
        function showBanModal() {
            document.getElementById('ban-modal').classList.add('active');
        }
        
        function closeBanModal() {
            document.getElementById('ban-modal').classList.remove('active');
            document.getElementById('ban-ip').value = '';
            document.getElementById('ban-reason').value = '';
            document.getElementById('ban-duration').value = '15';
        }
        
        async function submitBan() {
            const ip = document.getElementById('ban-ip').value.trim();
            const reason = document.getElementById('ban-reason').value.trim();
            const duration = parseInt(document.getElementById('ban-duration').value);
            
            if (!ip) {
                alert('Please enter an IP address');
                return;
            }
            
            try {
                const response = await fetch('/dashboard/api/bans', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': API_KEY
                    },
                    body: JSON.stringify({ ip, reason, minutes: duration })
                });
                
                if (response.ok) {
                    closeBanModal();
                    loadBans();
                    alert('IP banned successfully');
                } else {
                    const data = await response.json();
                    alert('Error: ' + (data.error || 'Failed to ban IP'));
                }
            } catch (error) {
                console.error('Error banning IP:', error);
                alert('Error banning IP');
            }
        }
        
        async function unbanIP(ip) {
            if (!confirm(`Unban IP ${ip}?`)) return;
            
            try {
                const response = await fetch(`/dashboard/api/bans/${ip}`, {
                    method: 'DELETE',
                    headers: {
                        'X-API-Key': API_KEY
                    }
                });
                
                if (response.ok) {
                    loadBans();
                    alert('IP unbanned successfully');
                } else {
                    alert('Error unbanning IP');
                }
            } catch (error) {
                console.error('Error unbanning IP:', error);
                alert('Error unbanning IP');
            }
        }
        
        function logout() {
            localStorage.removeItem('rwaf_api_key');
            window.location.href = '/dashboard/login';
        }
    </script>
</body>
</html>
