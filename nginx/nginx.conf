worker_processes auto;
worker_rlimit_nofile 65535;

events { 
    worker_connections 4096;
    use epoll;
    multi_accept on;
}

http {
    lua_package_path "/etc/nginx/lua/?.lua;;";
    
    lua_shared_dict waf_cache 10m;
    lua_shared_dict ban_cache 5m;
    
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    keepalive_requests 100;

    # - IPv4
    set_real_ip_from 173.245.48.0/20;
    set_real_ip_from 103.21.244.0/22;
    set_real_ip_from 103.22.200.0/22;
    set_real_ip_from 103.31.4.0/22;
    set_real_ip_from 141.101.64.0/18;
    set_real_ip_from 108.162.192.0/18;
    set_real_ip_from 190.93.240.0/20;
    set_real_ip_from 188.114.96.0/20;
    set_real_ip_from 197.234.240.0/22;
    set_real_ip_from 198.41.128.0/17;
    set_real_ip_from 162.158.0.0/15;
    set_real_ip_from 104.16.0.0/13;
    set_real_ip_from 104.24.0.0/14;
    set_real_ip_from 172.64.0.0/13;
    set_real_ip_from 131.0.72.0/22;
    set_real_ip_from 127.0.0.1;

    set_real_ip_from 10.10.0.1/16;
    set_real_ip_from 172.0.0.0/8;

    # - IPv6
    set_real_ip_from 2400:cb00::/32;
    set_real_ip_from 2606:4700::/32;
    set_real_ip_from 2803:f800::/32;
    set_real_ip_from 2405:b500::/32;
    set_real_ip_from 2405:8100::/32;
    set_real_ip_from 2a06:98c0::/29;
    set_real_ip_from 2c0f:f248::/32;

    real_ip_header CF-Connecting-IP;
    real_ip_recursive on;

    server {
        listen 80;
        client_max_body_size 10m;
        proxy_request_buffering off;

        error_page 403 /banned_page;

        #location / {
        #    resolver 127.0.0.11 ipv6=off;
        #    access_by_lua_file /etc/nginx/lua/rwaf.lua;
        #    root /www;
        #    autoindex on;
        #}

        location / {
            resolver 127.0.0.11 ipv6=off valid=30s;
            
            access_by_lua_block {
                local rwaf = require "rwaf"
                rwaf.check_request()
            }
            
            body_filter_by_lua_block {
                local rwaf = require "rwaf"
                rwaf.accumulate_response_body()
            }
            
            log_by_lua_block {
                local rwaf = require "rwaf"
                rwaf.check_response_async()
            }

            proxy_pass http://$WEB_SERVER_HOST:$WEB_SERVER_PORT;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $server_name;
            proxy_redirect off;
            proxy_buffering off;
            proxy_read_timeout 300s;
            proxy_send_timeout 300s;
        }

        location /banned_page {
            proxy_pass http://r-waf:5000/banned_page;
        }

    }

}
